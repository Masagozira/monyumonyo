using System.Collections;
using UnityEngine;

/// <summary>
/// ?????????????G?t?F?N?g?????X
/// ????????????
/// ?E?????????FFloEffect();
/// ?E??????????FOdrEffect();
/// ?E????????X???s?FFailEffect();
/// </summary>
public class PlayerEffect : MonoBehaviour
{
    //??????????G?t?F?N?g
    [SerializeField, Header("??????????G?t?F?N?g")]
    private ParticleSystem _florusEffect;
    private ParticleSystem.MainModule _florusEffectTime;
    //???????????G?t?F?N?g
    [SerializeField, Header("???????????G?t?F?N?g")]
    private ParticleSystem _odorEffect;
    private ParticleSystem.MainModule _odorEffectTime;
    //????????????s??G?t?F?N?g
    [SerializeField, Header("????????????s??G?t?F?N?g")]
    private ParticleSystem _failEffect;
    private ParticleSystem.MainModule _failEffectTime;

    [SerializeField, Header("?????p??????")]
    private float _floEffectTime = 5f;
    [SerializeField, Header("?????p??????")]
    private float _OdrEffectTime = 4f;

    // ?^?O????????????
    private bool istag1 = false;  // ?^?O1?i"Florus"?j??????????????????????t???O
    private bool istag2 = false;  // ?^?O2?i"Odor"?j??????????????????????t???O
    public float ChangeTime1 = 5.0f;  // ?^?O1????????????????
    public float ChangeTime2 = 4.0f;  // ?^?O2????????????????
    public float ChangeTime = 0.0f;  // ?????????????o?????
    private float CooldownTime = 3.0f;  // ???: ?N?[???_?E??????
    private bool isInCooldown = false;  // ???: ?N?[???_?E?????????????t???O

    //???????
    private void Start()
    {
        //?G?t?F?N?g?p?????????????????G?t?F?N?g???w??
        _florusEffectTime = _florusEffect.main;
        _odorEffectTime = _odorEffect.main;
        _failEffectTime = _failEffect.main;

        //?????p?????????
        _florusEffectTime.duration = _floEffectTime;
        _odorEffectTime.duration = _OdrEffectTime;
        _failEffectTime.duration = 1;

        Cursor.visible = false;
        // ?Q?[???J?n????"Player"?^?O??????I?u?W?F?N?g?????????A???O??\??
        GameObject[] objs = GameObject.FindGameObjectsWithTag("Player");
        foreach (GameObject obj in objs)
        {
            //Debug.Log(obj.gameObject.name);
        }
        Transform parentTransform = transform; // ???????e?I?u?W?F?N?g??Transform??u?????????????????
        GetLayersRecursiveEff(parentTransform);
    }

    //???s?p?A???????????
    private void Update()
    {
        if (isInCooldown)
        {
            if(Input.GetKeyDown(KeyCode.W)||Input.GetKeyDown(KeyCode.S))
            {
                FailEffect();
            }
            // ?N?[???_?E??????????????
            return;
        }
        // ?^?O????????????
        if (istag1 || istag2)
        {
            ChangeTime += Time.deltaTime;
            // ??????????????w???????????
            if (ChangeTime >= (istag1 ? ChangeTime1 : ChangeTime2))
            {
                EndChangeTagEff();  // ?^?O?????????I??????
                StartCooldownEff();  // ????????N?[???_?E?????J?n
            }
            return;
        }
        // "Florus"?^?O???????????
        if (!istag1 && Input.GetKeyDown(KeyCode.W))
        {
            FloEffect();
            istag1 = true;
            ChangeTime = 0.0f;
            Debug.Log("Florus?????X???????");
        }
        // "Odor"?^?O???????????
        if (!istag2 && Input.GetKeyDown(KeyCode.S))
        {
            OdrEffect();
            istag2 = true;
            ChangeTime = 0.0f;
            Debug.Log("Odor?????X???????");
        }
    }

    //????????X????????v???C???[??G?t?F?N?g
    //?v???C???[??????????????????

    /// <summary>
    /// ?????????????X
    /// </summary>
    public void FloEffect()
    {
        Vector3 playerPosition;
        // ?v???C???[???u?????
        playerPosition = transform.position;

        // // ?v???n?u??????V?????C???X?^???X??????A??u???v???C???[???u????
        ParticleSystem floEffectInstance = Instantiate(_florusEffect, playerPosition, Quaternion.identity, transform);

        //?????????????X
        Debug.Log("Effect:Flo");
        //Instantiate(_florusEffect, transform);
        _florusEffect.Play();
        _florusEffect.Stop(true, ParticleSystemStopBehavior.StopEmitting);

    }
    /// <summary>
    /// ??????????????X
    /// </summary>
    public void OdrEffect()
    {
        Vector3 playerPosition;
        // ?v???C???[???u?????
        playerPosition = transform.position;
        // ?v???n?u??????V?????C???X?^???X??????A??u???v???C???[???u????
        ParticleSystem floEffectInstance = Instantiate(_odorEffect, playerPosition, Quaternion.identity, transform);

        Debug.Log("Effect:Odr");
        //Instantiate(_odorEffect, transform);
        _odorEffect.Play();
        _odorEffect.Stop(true, ParticleSystemStopBehavior.StopEmitting);
    }

    /// <summary>
    /// ????????X???s
    /// </summary>
    public void FailEffect()
    {
        Vector3 playerPosition;
        // ?v???C???[???u?????
        playerPosition = transform.position;

        // ?v???n?u??????V?????C???X?^???X??????A??u???v???C???[???u????
        ParticleSystem floEffectInstance = Instantiate(_failEffect, playerPosition, Quaternion.identity, transform);

        Debug.Log("Effect:Non");
        //Instantiate(_failEffect, transform);
        _failEffect.Play();
        _failEffect.Stop(true, ParticleSystemStopBehavior.StopEmitting);
    }
    void GetLayersRecursiveEff(Transform parent)
    {
        foreach (Transform child in parent)
        {
            // ?q?I?u?W?F?N?g????C???[?????
            int layer = child.gameObject.layer;
            Debug.Log(child.name + " ????C???[: " + LayerMask.LayerToName(layer));

            // ????A?I??q?I?u?W?F?N?g????C???[?????
            GetLayersRecursiveEff(child);
        }
    }
    // ?^?O?????????I??????????????^?O???????\?b?h
    void EndChangeTagEff()
    {
        istag1 = false;
        istag2 = false;
    }
    // ???: ?N?[???_?E?????J?n??????\?b?h
    void StartCooldownEff()
    {
        StartCoroutine(CooldownCoroutineEff());
    }
    // ???: ?N?[???_?E????R???[?`??
    IEnumerator CooldownCoroutineEff()
    {
        isInCooldown = true;
        yield return new WaitForSeconds(CooldownTime);
        isInCooldown = false;
    }
}
/*
   ????X?_?@Effect???????????private????public?????X?@

    Effect????????u????

    // ?v???C???[???u?????
    Vector3 playerPosition = transform.position;
    // ?v???n?u??????V?????C???X?^???X??????A??u???v???C???[???u????
    ParticleSystem floEffectInstance = Instantiate(_florusEffect, playerPosition, Quaternion.identity, transform);
*/


